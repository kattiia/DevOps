# Stage 1: Build environment
FROM python:3.10-slim AS builder

WORKDIR /install

COPY requirements.txt .
RUN pip install --upgrade pip \
 && pip wheel --no-cache-dir --wheel-dir=/install/wheels -r requirements.txt

# Stage 2: Runtime
FROM python:3.10-slim AS runtime

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ wheel
COPY --from=builder /install/wheels /wheels
COPY requirements.txt .
RUN pip install --no-cache-dir --no-index --find-links=/wheels -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
COPY . /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ git (–Ω—É–∂–µ–Ω DVC)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π git (–Ω—É–∂–Ω–æ DVC)
RUN git init && git config user.email "123@example.com" && git config user.name "Name"

RUN sh -c '[ -d ".dvc" ] || (echo "üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DVC..." && dvc init --no-scm)'
RUN sh -c '! dvc remote list | grep -q "^storage" && \
  echo "üîó –î–æ–±–∞–≤–ª–µ–Ω–∏–µ remote-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞..." && \
  dvc remote add -d storage s3://${S3_BUCKET}/co2-project || \
  echo "‚úÖ Remote 'storage' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ"'
RUN dvc config core.remote storage

CMD ["bash", "scripts/dvc_pipeline.sh"]

